<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Invoice Processing Demo</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 2rem;
        max-width: 800px;
      }
      h1 {
        font-size: 1.6rem;
        margin-bottom: 0.5rem;
      }
      p.description {
        color: #555;
        margin-bottom: 1.5rem;
      }
      form {
        margin-bottom: 1.5rem;
        padding: 1rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #fafafa;
      }
      button {
        margin-top: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        border: 1px solid #0f766e;
        background-color: #0d9488;
        color: white;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.7;
        cursor: default;
      }
      #status {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: #555;
      }
      #error {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: #b91c1c;
      }
      pre {
        white-space: pre-wrap;
        background-color: #0f172a;
        color: #e5e7eb;
        padding: 1rem;
        border-radius: 4px;
        max-height: 400px;
        overflow: auto;
        font-size: 0.85rem;
      }
    </style>
  </head>
  <body>
    <h1>Invoice Processing Demo</h1>
    <p class="description">
      Upload a PDF or image of an invoice. The backend will run OCR + LLM
      extraction, normalize and validate totals, and return structured JSON.
    </p>

    <form id="invoice-form">
      <label for="provider">Extraction Provider:</label><br />
      <select id="provider" name="provider">
        <option value="">Auto-detect (recommended)</option>
      </select>
      <br /><br />
      
      <label for="file">Invoice file (PDF or image):</label><br />
      <input id="file" name="file" type="file" accept=".pdf,image/*" required />
      <br />
      <button type="submit">Process invoice</button>
      <div id="status"></div>
      <div id="error"></div>
    </form>

    <div style="margin-top: 2rem;">
      <h3>Provider Information</h3>
      <div id="provider-info">Loading...</div>
    </div>

    <div style="margin-top: 2rem;">
      <h3>Extraction Metrics</h3>
      <div id="metrics-info">Loading...</div>
    </div>

    <h2>Response JSON</h2>
    <pre id="response-output">Waiting for a request...</pre>

    <script>
      const form = document.getElementById("invoice-form");
      const fileInput = document.getElementById("file");
      const providerSelect = document.getElementById("provider");
      const statusEl = document.getElementById("status");
      const errorEl = document.getElementById("error");
      const outputEl = document.getElementById("response-output");
      const providerInfoEl = document.getElementById("provider-info");
      const metricsInfoEl = document.getElementById("metrics-info");

      // Load provider information on page load
      async function loadProviderInfo() {
        try {
          const response = await fetch("/api/providers");
          const data = await response.json();
          
          // Update provider select
          providerSelect.innerHTML = '<option value="">Auto-detect (recommended)</option>';
          data.available.forEach(provider => {
            const option = document.createElement("option");
            option.value = provider;
            option.textContent = provider === "llama" ? "ü¶ô LlamaIndex" : 
                               provider === "openai" ? "ü§ñ OpenAI" : 
                               "üìÑ OCR Tesseract";
            if (provider === data.recommended) {
              option.textContent += " ‚≠ê";
            }
            providerSelect.appendChild(option);
          });
          
          // Update provider info display
          providerInfoEl.innerHTML = `
            <p><strong>Available providers:</strong> ${data.available.join(", ")}</p>
            <p><strong>Recommended:</strong> ${data.recommended}</p>
          `;
        } catch (err) {
          providerInfoEl.innerHTML = "<p>Error loading provider information.</p>";
        }
      }

      // Load metrics on page load
      async function loadMetrics() {
        try {
          const response = await fetch("/api/metrics");
          const data = await response.json();
          
          let metricsHtml = "<h4>Provider Statistics</h4>";
          if (Object.keys(data.provider_stats).length === 0) {
            metricsHtml += "<p>No extractions recorded yet.</p>";
          } else {
            for (const [provider, stats] of Object.entries(data.provider_stats)) {
              metricsHtml += `
                <div style="margin-bottom: 1rem; padding: 0.5rem; background: #f5f5f5; border-radius: 4px;">
                  <strong>${provider}</strong><br>
                  Success Rate: ${(stats.success_rate * 100).toFixed(1)}%<br>
                  Avg Processing Time: ${stats.avg_processing_time.toFixed(2)}s<br>
                  Total Extractions: ${stats.total_extractions}
                </div>
              `;
            }
          }
          
          metricsInfoEl.innerHTML = metricsHtml;
        } catch (err) {
          metricsInfoEl.innerHTML = "<p>Error loading metrics.</p>";
        }
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        errorEl.textContent = "";
        statusEl.textContent = "";

        const file = fileInput.files[0];
        if (!file) {
          errorEl.textContent = "Please select a file to upload.";
          return;
        }

        const formData = new FormData();
        formData.append("file", file);
        
        // Add provider to query params if selected
        const provider = providerSelect.value;
        let url = "/api/invoices/process";
        if (provider) {
          url += `?provider=${provider}`;
        }

        const submitButton = form.querySelector("button[type=submit]");
        submitButton.disabled = true;
        statusEl.textContent = "Processing...";
        outputEl.textContent = "";

        try {
          const response = await fetch(url, {
            method: "POST",
            body: formData,
          });

          const text = await response.text();

          if (!response.ok) {
            let message = `Request failed with status ${response.status}`;
            try {
              const data = JSON.parse(text);
              if (data && data.detail) {
                message += `: ${JSON.stringify(data.detail)}`;
              }
            } catch (e) {
              // Ignore JSON parse error for error body.
            }
            errorEl.textContent = message;
            outputEl.textContent = text || "";
          } else {
            let data;
            try {
              data = JSON.parse(text);
            } catch (e) {
              errorEl.textContent = "Response was not valid JSON.";
              outputEl.textContent = text || "";
              return;
            }
            outputEl.textContent = JSON.stringify(data, null, 2);
            statusEl.textContent = "Done.";
            
            // Reload metrics after successful extraction
            loadMetrics();
          }
        } catch (err) {
          console.error(err);
          errorEl.textContent = "Network or server error. Check console logs.";
        } finally {
          submitButton.disabled = false;
        }
      });

      // Load initial data
      loadProviderInfo();
      loadMetrics();
    </script>
  </body>
</html>
